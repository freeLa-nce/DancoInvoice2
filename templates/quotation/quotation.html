{% load static %}
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

    <style>
        .mb-0{
            margin-bottom: 0px !important;
        }

        .me-2{
            margin-right: 0.5rem !important;
        }
    </style>
</head>
    <link rel="stylesheet" href="{% static 'css/style.css' %}">
</head>

<body>

    <div class="dashboard" id="dashboard">
        <nav class="navbar navbar-expand-lg bg-blue ">
            <a class="navbar-brand pt-3" href="#">Navbar</a>
            <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent"
                aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>

        <div class="collapse navbar-collapse pt-4" id="navbarSupportedContent">
                <ul class="navbar-nav ms-0">
                    <li class="nav-item active mx-4">
                        <a class="nav-link active" href="quotation.html">
                            <i class="fas fa-file-invoice" style="margin-right: 8px;"></i> Quotation
                        </a>
                    </li>
                    <li class="nav-item mx-4">
                        <a class="nav-link" href="invoice.html">
                            <i class="fas fa-ticket-alt" style="margin-right: 8px;"></i> Invoice & Delivery
                        </a>
                    </li>
                    <li class="nav-item mx-4">
                        <a class="nav-link" href="{% url 'customer-view' %}">
                            <i class="fas fa-user" style="margin-right: 8px;"></i> Customer Data
                        </a>
                    </li>
                    <li class="nav-item mx-4">
                        <a class="nav-link" href="{% url 'product_view' %}">
                            <i class="fas fa-boxes" style="margin-right: 8px;"></i> Products
                        </a>
                    </li>
                </ul>

                <!-- Profile Dropdown -->
                <div class="dropdown ml-auto">
                    <a class="nav-link d-flex align-items-center" href="#" id="profileDropdown" role="button"
                       data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                        <img src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcTXJr-fGkiy1DE5A0JNOkcmCNGcXuQXdzENZA&s"
                             alt="" class="rounded-circle" width="50" height="50">
                        <div class="ml-1"> <!-- Adjusted margin for better spacing -->
                            <span class="d-block font-weight-bold fs-2">Erfan Khot</span>
                            <span class="d-block text-muted">Technical Officer</span>
                        </div>
                    </a>
            
                    <div class="dropdown-menu dropdown-menu-right" aria-labelledby="profileDropdown">
                        <a class="dropdown-item" href="#"><i class="fas fa-envelope mr-2"></i> Danaco@gmail.com</a>
                        <a class="dropdown-item" href="{% url 'reset_view'%}"><i class="fas fa-key mr-2"></i> Reset Password</a>
            
                        <div class="dropdown-divider"></div>
            
                        <a class="dropdown-item" href="#"><i class="fas fa-sign-out-alt mr-2"></i> Logout</a>
                    </div>
                </div>

            </div>
        </nav>

        <div class="container-fluid my-3" id="dashboard-content">
            <!-- <div class="ml-1">
                <h5>Quotation</h5>
            </div> -->
            <div class="row">
                
                <div class="col-md-6" style="background-color: #fff;">
                    <div class="d-flex justify-content-between align-items-center my-4">
                        <img src="{% static 'img/DANACO.png' %}" alt="Company Logo" class="logo">
                        <img src="{% static 'img/qr.png' %}" alt="QR Code" class="qr-code mr-3" style="height: 150px;width: 150px;">
                    </div>
                    
                    <p>Cecilia Chapman<br>711-2880 Nulla St.<br>Mankato Mississippi<br>96522<br>(257) 563-7401</p>
                    <div class="form-group mb-2 d-flex justify-content-end align-items-center">
                        <label for="invoice-date"class="mb-0 me-2">Quotation Date: </label>
                        <input type="date" class="form-control w-50" id="invoice-date" placeholder="Date" onchange="DisplayQuotationDate();">
                    </div>
                    <div class="container-2 my-4" id="product-row-container" style="padding: 0px 40px 0px 40px; background-color: #F3F3F3;">
                        <div class="add-product-row">
                            <div id="input-container" class="mt-3">
                                <div class="row mb-2 default-row">
                                    <div class="col-lg-5 mb-2" id="item-product-div">
                                        <h6>Item</h6>
                                        <!-- <input type="text" class="form-control-2" placeholder="Item Description"  required> -->
                                        <select class="form-control-2 item-description" id="item-description" data-placeholder="Item Description" style="width: 100%;" required></select>
                                        <div class="invalid-feedback">Please select an item.</div>

                                    </div>
                                    <div class="col-lg-3 mb-2">
                                        <h6>Quantity</h6>
                                        <input type="number" class="form-control-2" placeholder="Quantity" id="item-quantity"  required>
                                        <div class="invalid-feedback">Please enter a quantity.</div>

                                    </div>
                                    <div class="col-lg-3 mb-2">
                                        <h6>Amount</h6>
                                        <input type="number" class="form-control-2" placeholder="Price" id="item-price" required>
                                        <div class="invalid-feedback">Please enter an amount.</div>

                                    </div>
                                    <div class="col-lg-1 mb-2 d-flex align-items-end">
                                        <button type="button" class="btn btn-danger btn-sm" onclick="deleteRow(this)" disabled>
                                            <i class="fas fa-trash-alt"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col text-right">
                                    <button type="button" class="btn btn-primary my-2" id="add-row-btn" onclick="addProductRow()">Add Product</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-6">
                    <div class="row d-flex justify-content-between align-items-center">
                   
                        <!-- <div class="col-auto">
                            <a href="mailto:?subject=Quotation&body=Please find the attached quotation." class="btn btn-primary" id="share-quotation">
                                <i class="fas fa-share-alt"></i>
                            </a>
                        </div> -->
                    </div>
                    
                    
                
                    <div id="invoice-preview" class="border p-3" style="width: 100%; height: 29.7cm; position: relative;">
                        <div class="d-flex justify-content-between align-items-center">
                            <img src="{% static 'img/DANACO.png' %}" alt="Company Logo" class="logo">
                            <img src="{% static 'img/qr.png' %}" alt="QR Code" class="qr-code mr-3" style="height: 150px;width: 150px;">
                        </div>
                        <p class="my-2">Cecilia Chapman<br>711-2880 Nulla St.<br>Mankato Mississippi 96522<br>(257) 563-7401</p>
                        <p><strong>Date:</strong> <span id="display-invoice-date">--</span></p>
                        <div class="table-responsive mb-1">

                        </div>
                        <table class="table table-bordered" id="invoice-table">
                            <thead>
                                <tr>
                                    <th scope="col">Item Description</th>
                                    <th scope="col">Quantity</th>
                                    <th scope="col">Price</th>
                                    <th scope="col">Total</th>
                                </tr>
                            </thead>
                            <!-- <tbody id="invoice-table-body">
                           
                            </tbody> -->
                        </table>
                        <p style="text-align: end;"><strong>Total Amount:</strong>
                            KWD <span id="total-amount">0</span></p>
                        <div class="button-group" style="position: absolute; bottom: 20px; right: 20px;">
                            <button class="btn btn-success" id="print-invoice" onclick="PrintQuotation()">Print Quotation</button>
                        </div>
                    </div>
                </div>
                
            </div>
        </div>
    </div>

    <script src="https://kit.fontawesome.com/a076d05399.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://lottie.host/5da40bf1-867e-417e-ad44-1b63d4b82932/zn2Y8qg1M0.json"></script>
    <script src="{% static 'js/quotation/quotation.js' %}"></script>

    <script src="https://code.jquery.com/jquery-3.7.1.js" integrity="sha256-eKhayi8LEQwp4NKxN+CfCh+3qOVUtJn3QNZ0TciWLP4=" crossorigin="anonymous"></script>
    <link rel="stylesheet" href="{% static 'css\libs\notiflix\notiflix.min.css' %}">
    <script src="{% static 'js\libs\notiflix\notiflix-3.2.7.min.js' %}"></script>
    <script src="{% static 'js\danco.js' %}"></script>
    <!-- <script src="{% static 'js/script.js' %}"></script> -->

    <!-- Add these lines in the <head> section of your template -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/css/select2.min.css" rel="stylesheet" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/js/select2.min.js"></script>

    <link rel="stylesheet" href="https://cdn.datatables.net/2.1.8/css/dataTables.bootstrap4.css">
</body>

<script id="messages" type="application/json">
    {{ messages|json_script:"messages" }}
</script>

<script src="https://cdn.datatables.net/2.1.8/js/dataTables.js"></script>
<script src="https://cdn.datatables.net/2.1.8/js/dataTables.bootstrap4.js"></script>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        debugger;
        // Get the content of the script tag by its ID
        const scriptContent = document.getElementById('messages').textContent.trim();
        const messages = extractMessagesFromContent(scriptContent);
        // Parse the content as JSON
        if(messages != "" || messages != []){
        // Now process the messages and display them using Notiflix
            messages.forEach(msg => {
                const messageText = msg.message;
                const messageTag = msg.tags;  // 'success', 'error', etc.

                if(messageText == "Session expired, please log in again."){
                    ErrorAlert(messageText);
                    setTimeout(() => {
                        window.location.href = '{% url "login" %}';
                    }, 2000); // Adjust the delay as needed
                }
                if (messageTag.includes('success')) {
                    SuccessAlert(messageText);
                } else if (messageTag.includes('error')) {
                    ErrorAlert(messageText);
                } else if (messageTag.includes('warning')) {
                    WarningAlert(messageText);
                } else {
                    InfoAlert(messageText);
                }
            });
        }

        $('#invoice-table').DataTable({
            data: [], // Empty data as no products are added initially
            columns: [
                { title: "Item Description" },
                { title: "Quantity" },
                { title: "Price" },
                { title: "Total" }
            ],
            searching: false, // Disable searching
            paging: false, // Disable pagination
            destroy: true, // Destroy any previous instance before reinitialization
            info: false,
            language: {
                emptyTable: "No products added" // Display message when table is empty
            }
        });


        // $('.item-description').select2({
        //     placeholder: 'Search for an item',
        //     minimumInputLength: 4,  // Trigger search after 4 characters
        //     ajax: {
        //         url: "{% url 'search_items' %}",  // URL for the search view
        //         dataType: 'json',
        //         delay: 250,
        //         data: function(params) {
        //             return {
        //                 term: params.term  // Send the search term as a query parameter
        //             };
        //         },
        //         processResults: function(data) {
        //             return {
        //                 results: data  // Process results into Select2 format
        //             };
        //         }
        //     }
        // });

        // Event listener for selecting an item from the list
        $('.item-description').on('select2:select', function(e) {
            var data = e.params.data;
            $('#item-quantity').val(data.quantity);  // Populate the Quantity field
            $('#item-price').val(data.price);   
            $("#item-price").prop("disabled",true);     // Populate the Price field
        });

        InitializeAllSelect2();
    });

    function DisplayQuotationDate(){
        const selectedDate = document.getElementById('invoice-date').value;
        // document.getElementById('display-invoice-date').textContent = selectedDate;
        if (selectedDate) { // Check if a date is selected
            const [year, month, day] = selectedDate.split("-"); // Split the date into parts
            const formattedDate = `${day}-${month}-${year}`; // Rearrange to dd-mm-yyyy
            document.getElementById('display-invoice-date').textContent = formattedDate;
        }
    }

    function addProductRow() {

        let isValid = true;

        // Check if each required field has a value
        $('.default-row input, .default-row select').each(function() {
            if (!$(this).val()) {
                $(this).addClass('is-invalid'); // Add Bootstrap's invalid class
                isValid = false;
            } else {
                $(this).removeClass('is-invalid'); // Remove invalid class if value exists
            }
        });

        if (isValid) {


            let itemDescription = $('#item-description').find(':selected').text();
            let itemQuantity = parseFloat($('#item-quantity').val()) || 0;
            let itemPrice = parseFloat($('#item-price').val()) || 0;
            let itemTotal = itemQuantity * itemPrice;

            var table;
            // Check if DataTable has already been initialized
            if (!$.fn.DataTable.isDataTable('#invoice-table')) {
                table = $('#invoice-table').DataTable({
                    destroy: true,
                    searching: false,
                    paging: true,
                    lengthChange: false,
                    info: false,
                    pageLength: 5,
                    scrollX: true,
                });
            } else {
                table = $('#invoice-table').DataTable();
            }

             // Add row to DataTable
            table.row.add([
                itemDescription,
                itemQuantity,
                itemPrice.toFixed(2),
                itemTotal.toFixed(2)
            ]).draw();

            //table.row.add(newData).draw(false); // 'false' means do not reset the paging
            table.draw(); // This will redraw the entire DataTable and reset the paging
            // Clone the first .default-row (the entire row)
                    // Calculate and update the total amount
            calculateTotalAmount();

            // Generate a unique ID
            const uniqueId = `item-description-${Date.now()}`;
            var newRow = $('.default-row').first().clone();

            // Clear the input values in the cloned row
            clearRowInputs(newRow);

            newRow.find('.select2').remove();
            newRow.find('.item-description').remove();

            // Remove the Select2 container from the cloned row (if it exists)
            //newRow.find('#${uniqueId}').remove();  // Remove the Select2 wrapper

            // Append the new select element
            newRow.find('.col-lg-5').html(`
                <select class="form-control-2 item-description" id="${uniqueId}" data-placeholder="Item Description" style="width: 100%;" required>
                </select>
            `);

            // Initialize Select2 for the newly added select element in the cloned row
            // Initialize Select2 with AJAX inside the cloned row
            newRow.find(`#${uniqueId}`).select2({
                placeholder: 'Search for an item',
                minimumInputLength: 4,  // Trigger search after 4 characters
                ajax: {
                    url: "{% url 'search_items' %}",  // URL for the search view
                    dataType: 'json',
                    delay: 250,
                    data: function(params) {
                        return {
                            term: params.term  // Send the search term as a query parameter
                        };
                    },
                    processResults: function(data) {
                        return {
                            results: data  // Process results into Select2 format
                        };
                    }
                }
            });

            // Event listener for selecting an item from the list in the cloned row
            newRow.find(`#${uniqueId}`).on('select2:select', function(e) {
                var data = e.params.data;
                newRow.find('#item-quantity').val(data.quantity);  // Populate the Quantity field in the cloned row
                newRow.find('#item-price').val(data.price);        // Populate the Price field in the cloned row
            });
            // newRow.find('select').val(null).trigger('change');  // Reset the select2 dropdown

            // Enable the delete button for the cloned row
            enableDeleteButton(newRow);

            // Append the cloned row to #input-container (last position)
            $('#input-container').append(newRow);

            InitializeAllSelect2();
        }

        // Initialize Select2 for the newly added row (only)
        //initializeSelect2(newRow);

        // Reinitialize Select2 on all previous rows (this prevents it from being lost)
    // $('.select2').select2({
    //     placeholder: 'Search for an item',
    //     minimumInputLength: 4,
    //     ajax: {
    //         url: "{% url 'search_items' %}",
    //         dataType: 'json',
    //         delay: 250,
    //         data: function(params) {
    //             return {
    //                 term: params.term
    //             };
    //         },
    //         processResults: function(data) {
    //             return {
    //                 results: data
    //             };
    //         }
    //     }
    // });
    }

    // Function to clear input fields in a row
    function clearRowInputs(row) {
        row.find('input').val('');  // Clear the input fields
        row.find('select').val(null).trigger('change');  // Reset Select2 field (if used)
    }

    // Function to enable the delete button for a cloned row
    function enableDeleteButton(row) {
        row.find('.btn-danger').prop('disabled', false);  // Enable the delete button
    }

    // Function to delete a row
    function deleteRow(button) {
        $(button).closest('.row').remove();  // Remove the row containing the delete button
    }

    

// Function to calculate the total amount
function calculateTotalAmount() {
    let totalAmount = 0;

    // Iterate over each row in the DataTable
    $('#invoice-table').DataTable().rows().every(function() {
        let data = this.data();
        let rowTotal = parseFloat(data[3]); // Assuming 'Total' is in the fourth column
        if (!isNaN(rowTotal)) {
            totalAmount += rowTotal;
        }
    });

    // Update the total amount display
    $('#total-amount').text(totalAmount.toFixed(2));
}

function PrintQuotation(){
// Select the invoice section
    var invoiceContent = document.getElementById("invoice-preview").innerHTML;

    // Collect product data from the table
    let productData = [];
    $('#invoice-table').DataTable().rows().every(function() {
        let data = this.data();
        let productName = data[0];   // Assuming the product name is in the first column
        let productQuantity = parseInt(data[1]); // Assuming the quantity is in the second column
        if (!isNaN(productQuantity)) {
            productData.push({ name: productName, quantity: productQuantity });
        }
    });

    // AJAX request to send product data to the server
    $.ajax({
        url: "{% url 'update-product-quantity' %}", // Server route for updating product quantity
        type: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({ products: productData }),
        success: function(response) {
            if (response.success) {
                // Proceed to print after updating quantities
                printInvoiceContent(invoiceContent);
            } else {
                ErrorAlert("Error updating product quantities. Please try again.");
            }
        },
        error: function() {
            ErrorAlert("Failed to connect to the server.");
        }
    });
}

function InitializeAllSelect2() {
    debugger;
    // $('.item-description').each(function() {
    //     if ($(this).data('select2')) {
    //         $(this).select2('destroy'); // Destroy the existing Select2 instance
    //     }
    // });

    // Reinitialize Select2 for all elements
    $('.item-description').select2({
        placeholder: 'Search for an item',
        minimumInputLength: 4,
        ajax: {
            url: "{% url 'search_items' %}", // URL for the search view
            dataType: 'json',
            delay: 250,
            data: function(params) {
                return {
                    term: params.term // Send the search term as a query parameter
                };
            },
            processResults: function(data) {
                return {
                    results: data // Process results into Select2 format
                };
            }
        }
    });

}


// Function to open the print window and print the content
function printInvoiceContent(invoiceContent) {
var printWindow = window.open('', '', 'height=600,width=800');
printWindow.document.write('<html><head><title>Print Invoice</title>');
printWindow.document.write('<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">');
printWindow.document.write('<style>@media print { body { margin: 0; } }</style>');
printWindow.document.write('</head><body>');
printWindow.document.write(invoiceContent);
printWindow.document.write('</body></html>');
printWindow.document.close();

printWindow.onload = function() {
    printWindow.print();
    printWindow.close();
};
}


</script>

</html>